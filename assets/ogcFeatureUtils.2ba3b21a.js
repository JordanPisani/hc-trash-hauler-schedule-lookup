import{q as X,t as w,u as g,_ as $,dK as Y,bT as ee,h as k,cj as te,r as O,b2 as R,bS as ne}from"./index.b4c7b16d.js";import{s as ie,n as ae,t as re}from"./featureConversionUtils.1a47e5d5.js";import{e as se}from"./OptimizedFeatureSet.2574e09f.js";import{O as oe,T as le,L as ce}from"./geojson.f01f634a.js";import{n as de}from"./clientSideDefaults.c6ba7436.js";var ue=Object.defineProperty,fe=Object.defineProperties,pe=Object.getOwnPropertyDescriptors,W=Object.getOwnPropertySymbols,me=Object.prototype.hasOwnProperty,ge=Object.prototype.propertyIsEnumerable,G=(t,e,n)=>e in t?ue(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,y=(t,e)=>{for(var n in e||(e={}))me.call(e,n)&&G(t,n,e[n]);if(W)for(var n of W(e))ge.call(e,n)&&G(t,n,e[n]);return t},F=(t,e)=>fe(t,pe(e));const x=X.getLogger("esri.layers.graphics.sources.ogcfeature"),K="http://www.opengis.net/def/crs/",Oe=`${K}OGC/1.3/CRS84`;async function ve(t,e,n={},i=5){const{links:o}=t,l=p(o,"items","application/geo+json")||p(o,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(w(l))throw new g("ogc-feature-layer:missing-items-page","Missing items url");const{data:d}=await $(l.href,{signal:n.signal,query:F(y({limit:i},n.customParameters),{token:n.apiKey}),headers:{accept:"application/geo+json"}});await oe(d);const r=le(d,{geometryType:e.geometryType}),f=e.fields||r.fields||[],v=e.hasZ!=null?e.hasZ:r.hasZ,j=r.geometryType,m=e.objectIdField||r.objectIdFieldName||"OBJECTID";let s=e.timeInfo;const b=f.find(a=>a.name===m);if(b)b.type="esriFieldTypeOID",b.editable=!1,b.nullable=!1;else{if(!r.objectIdFieldType)throw new g("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");f.unshift({name:m,alias:m,type:"esriFieldTypeOID",editable:!1,nullable:!1})}if(m!==r.objectIdFieldName){const a=f.find(c=>c.name===r.objectIdFieldName);a&&(a.type="esriFieldTypeInteger")}f===r.fields&&r.unknownFields.length>0&&x.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:r.unknownFields}});for(const a of f){if(a.name==null&&(a.name=a.alias),a.alias==null&&(a.alias=a.name),a.type!=="esriFieldTypeOID"&&a.type!=="esriFieldTypeGlobalID"&&(a.editable=a.editable==null||!!a.editable,a.nullable=a.nullable==null||!!a.nullable),!a.name)throw new g("ogc-feature-layer:invalid-field-name","field name is missing",{field:a});if(Y.jsonValues.indexOf(a.type)===-1)throw new g("ogc-feature-layer:invalid-field-type",`invalid type for field "${a.name}"`,{field:a})}if(s){const a=new ee(f);if(s.startTimeField){const c=a.get(s.startTimeField);c?(s.startTimeField=c.name,c.type="esriFieldTypeDate"):s.startTimeField=null}if(s.endTimeField){const c=a.get(s.endTimeField);c?(s.endTimeField=c.name,c.type="esriFieldTypeDate"):s.endTimeField=null}if(s.trackIdField){const c=a.get(s.trackIdField);c?s.trackIdField=c.name:(s.trackIdField=null,x.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:s}}))}s.startTimeField||s.endTimeField||(x.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:s}}),s=null)}return{drawingInfo:j?de(j):null,geometryType:j,fields:f,hasZ:!!v,objectIdField:m,timeInfo:s}}async function Pe(t,e={}){const{links:n}=t,i=p(n,"data","application/json")||p(n,"http://www.opengis.net/def/rel/ogc/1.0/data","application/json");if(w(i))throw new g("ogc-feature-layer:missing-collections-page","Missing collections url");const{apiKey:o,customParameters:l,signal:d}=e,{data:r}=await $(i.href,{signal:d,headers:{accept:"application/json"},query:F(y({},l),{token:o})});return r}async function _e(t,e={}){const{links:n}=t,i=p(n,"conformance","application/json")||p(n,"http://www.opengis.net/def/rel/ogc/1.0/conformance","application/json");if(w(i))throw new g("ogc-feature-layer:missing-conformance-page","Missing conformance url");const{apiKey:o,customParameters:l,signal:d}=e,{data:r}=await $(i.href,{signal:d,headers:{accept:"application/json"},query:F(y({},l),{token:o})});return r}async function Se(t,e={}){const{apiKey:n,customParameters:i,signal:o}=e,{data:l}=await $(t,{signal:o,headers:{accept:"application/json"},query:F(y({},i),{token:n})});return l}async function xe(t,e={}){const n="application/vnd.oai.openapi+json;version=3.0",i=p(t.links,"service-desc",n);if(w(i))return x.warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;const{apiKey:o,customParameters:l,signal:d}=e,{data:r}=await $(i.href,{signal:d,headers:{accept:n},query:F(y({},l),{token:o})});return r}function Ne(t){const e=/^http:\/\/www\.opengis.net\/def\/crs\/(?<authority>.*)\/(?<version>.*)\/(?<code>.*)$/i.exec(t),n=e==null?void 0:e.groups;if(!n)return null;const{authority:i,code:o}=n;switch(i.toLowerCase()){case"ogc":switch(o.toLowerCase()){case"crs27":return k.GCS_NAD_1927.wkid;case"crs83":return 4269;case"crs84":case"crs84h":return k.WGS84.wkid;default:return null}case"esri":case"epsg":{const l=Number.parseInt(o,10);return Number.isNaN(l)?null:l}default:return null}}async function qe(t,e,n){const i=await ye(t,e,n);return ie(i)}async function ye(t,e,n){const{capabilities:{query:{maxRecordCount:i}},collection:o,layerDefinition:l,queryParameters:{apiKey:d,customParameters:r},spatialReference:f,supportedCrs:v}=t,{links:j}=o,m=p(j,"items","application/geo+json")||p(j,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(w(m))throw new g("ogc-feature-layer:missing-items-page","Missing items url");const{geometry:s,num:b,start:a,timeExtent:c,where:L}=e;if(e.objectIds)throw new g("ogc-feature-layer:query-by-objectids-not-supported","Queries with objectids are not supported");const E=k.fromJSON(f),T=te(e.outSpatialReference,E),P=T.isWGS84?null:Z(T,v),A=Ie(s,v),J=be(c),V=he(L),B=b!=null?b:a!=null&&a!==void 0?10:i,{data:h}=await $(m.href,F(y({},n),{query:F(y(y({},r),A),{crs:P,datetime:J,query:V,limit:B,startindex:a,token:d}),headers:{accept:"application/geo+json"}}));let _=!1;h.links&&(_=!!h.links.find(S=>S.rel==="next")),!_&&Number.isInteger(h.numberMatched)&&Number.isInteger(h.numberReturned)&&(_=h.numberReturned<h.numberMatched);const{fields:Q,globalIdField:z,hasM:H,hasZ:N,objectIdField:q}=l,M=l.geometryType,C=ce(h,{geometryType:M,hasZ:N,objectIdField:q});if(!P&&T.isWebMercator){for(const I of C)if(O(I.geometry)){const S=ae(I.geometry,M,N,!1);S.spatialReference=k.WGS84,I.geometry=re(R(S,T))}}for(const I of C)I.objectId=I.attributes[q];const U=P||!P&&T.isWebMercator?T.toJSON():ne,u=new se;return u.exceededTransferLimit=_,u.features=C,u.fields=Q,u.geometryType=M,u.globalIdFieldName=z,u.hasM=H,u.hasZ=N,u.objectIdFieldName=q,u.spatialReference=U,u}function we(t){return O(t)&&t.type==="extent"}function Z(t,e){var n,i,o;const{isWebMercator:l,wkid:d}=t;if(!d)return null;const r=l?(n=(i=(o=e[3857])!=null?o:e[102100])!=null?i:e[102113])!=null?n:e[900913]:e[t.wkid];return r?`${K}${r}`:null}function D(t){if(w(t))return"";const{xmin:e,ymin:n,xmax:i,ymax:o}=t;return`${e},${n},${i},${o}`}function be(t){if(w(t))return null;const{start:e,end:n}=t;return`${O(e)?e.toISOString():".."}/${O(n)?n.toISOString():".."}`}function he(t){return w(t)||!t||t==="1=1"?null:t}function Ie(t,e){if(!we(t))return null;const{spatialReference:n}=t;if(!n||n.isWGS84)return{bbox:D(t)};const i=Z(n,e);return O(i)?{bbox:D(t),"bbox-crs":i}:n.isWebMercator?{bbox:D(R(t,k.WGS84))}:null}function p(t,e,n){return t.find(i=>i.rel===e&&i.type===n)||t.find(i=>i.rel===e&&!i.type)}export{Oe as F,ve as I,qe as N,xe as S,Pe as T,K as j,_e as k,ye as q,Ne as v,Se as x};
